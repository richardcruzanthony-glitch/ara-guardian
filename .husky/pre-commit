#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook to detect secrets
echo "üîç Scanning for secrets..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No staged files to check"
  exit 0
fi

# Check for common secret patterns
SECRETS_FOUND=0

# Check each pattern
echo "$STAGED_FILES" | xargs grep -iE "supersecretkey" 2>/dev/null && SECRETS_FOUND=1
echo "$STAGED_FILES" | xargs grep -iE "BEGIN RSA PRIVATE KEY|BEGIN PRIVATE KEY" 2>/dev/null && SECRETS_FOUND=1
echo "$STAGED_FILES" | xargs grep -iE "aws_access_key_id|aws_secret_access_key" 2>/dev/null && SECRETS_FOUND=1
echo "$STAGED_FILES" | xargs grep -iE "AKIA[0-9A-Z]{16}" 2>/dev/null && SECRETS_FOUND=1
echo "$STAGED_FILES" | xargs grep -iE "ghp_[0-9a-zA-Z]{36}|gho_[0-9a-zA-Z]{36}" 2>/dev/null && SECRETS_FOUND=1
echo "$STAGED_FILES" | xargs grep -iE "sk-[A-Za-z0-9]{32,}" 2>/dev/null && SECRETS_FOUND=1

if [ $SECRETS_FOUND -eq 1 ]; then
  echo ""
  echo "‚ùå COMMIT BLOCKED: Potential secrets detected in staged files!"
  echo ""
  echo "Please review the flagged content and ensure no secrets are committed."
  echo "If this is a false positive, you can:"
  echo "  1. Update the secret pattern detection in .husky/pre-commit"
  echo "  2. Use git commit --no-verify (NOT recommended for actual secrets)"
  echo ""
  exit 1
fi

echo "‚úÖ No secrets detected"
exit 0
